Create database PBL;
USE PBL;

-- Patients Table
CREATE TABLE Patients (
    patient_id INT PRIMARY KEY AUTO_INCREMENT,
    first_name VARCHAR(50) NOT NULL,
    last_name VARCHAR(50),
    gender VARCHAR(10),
    date_of_birth DATE,
    phone VARCHAR(15),
    email VARCHAR(100),
    address VARCHAR(255),
    blood_group VARCHAR(5),
    allergies VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Doctors Table
CREATE TABLE Doctors (
    doctor_id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    specialization VARCHAR(100),
    qualification VARCHAR(100),
    phone VARCHAR(15),
    email VARCHAR(100),
    consult_fee DECIMAL(10,2),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Departments Table (optional)
CREATE TABLE Departments (
    dept_id INT PRIMARY KEY AUTO_INCREMENT,
    dept_name VARCHAR(100) NOT NULL,
    location VARCHAR(100)
);

-- Doctor_Department (many-to-one/many-to-many mapping)
CREATE TABLE Doctor_Department (
    id INT PRIMARY KEY AUTO_INCREMENT,
    doctor_id INT,
    dept_id INT,
    FOREIGN KEY (doctor_id) REFERENCES Doctors(doctor_id),
    FOREIGN KEY (dept_id) REFERENCES Departments(dept_id)
);

-- Appointments Table
CREATE TABLE Appointments (
    appointment_id INT PRIMARY KEY AUTO_INCREMENT,
    patient_id INT,
    doctor_id INT,
    appointment_date DATETIME,
    reason VARCHAR(255),
    status VARCHAR(20) DEFAULT 'Scheduled', -- Scheduled, Completed, Cancelled, No-Show
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (patient_id) REFERENCES Patients(patient_id),
    FOREIGN KEY (doctor_id) REFERENCES Doctors(doctor_id)
);

-- Medical Reports Table
CREATE TABLE MedicalReports (
    report_id INT PRIMARY KEY AUTO_INCREMENT,
    patient_id INT,
    doctor_id INT,
    appointment_id INT NULL,
    report_date DATE,
    report_type VARCHAR(50), -- e.g., "Blood Test", "X-Ray", "Prescription"
    summary TEXT,
    file_path VARCHAR(255), -- optional: path to scanned report
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (patient_id) REFERENCES Patients(patient_id),
    FOREIGN KEY (doctor_id) REFERENCES Doctors(doctor_id),
    FOREIGN KEY (appointment_id) REFERENCES Appointments(appointment_id)
);

-- Users / Staff Table (for admin login, optional)
CREATE TABLE Users (
    user_id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role VARCHAR(20), -- 'Admin','Reception','Doctor','Lab'
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Departments
INSERT INTO Departments (dept_name, location) VALUES
('General Medicine', 'Floor 1'),
('Orthopedics', 'Floor 2'),
('Radiology', 'Ground Floor');

-- Doctors
INSERT INTO Doctors (name, specialization, qualification, phone, email, consult_fee) VALUES
('Dr. Ravi Mehta','General Medicine','MBBS,MD','9876543210','ravi.mehta@hospital.com',500.00),
('Dr. Anjali Singh','Orthopedics','MBBS,MS','9876501234','anjali.singh@hospital.com',700.00),
('Dr. Suresh Rao','Radiology','MBBS','9876509876','suresh.rao@hospital.com',600.00);

-- Map doctors to departments
INSERT INTO Doctor_Department (doctor_id, dept_id) VALUES
(1, 1),(2, 2),(3, 3);

-- Patients
INSERT INTO Patients (first_name,last_name,gender,date_of_birth,phone,email,address,blood_group,allergies) VALUES
('Amit','Kumar','Male','1990-05-12','9123456780','amit.k@example.com','Sector 17, Chandigarh','O+','None'),
('Seema','Rana','Female','1985-09-23','9012345678','seema.r@example.com','Sector 22, Chandigarh','A+','Penicillin');

-- Appointments (use DATETIME)
INSERT INTO Appointments (patient_id, doctor_id, appointment_date, reason, status) VALUES
(1, 1, '2025-11-03 10:00:00', 'Fever and cold', 'Scheduled'),
(2, 2, '2025-11-03 11:30:00', 'Knee pain', 'Scheduled');

-- Medical Reports
INSERT INTO MedicalReports (patient_id, doctor_id, appointment_id, report_date, report_type, summary, file_path) VALUES
(1, 1, 1, '2025-11-03', 'Blood Test', 'CBC normal, mild leukocytosis', '/reports/amit_blood_20251103.pdf'),
(2, 2, NULL, '2025-10-20', 'X-Ray', 'No fracture seen', '/reports/seema_xray_20251020.pdf');


-- 1. Get patient full medical history (reports + appointments)
SELECT p.patient_id, p.first_name, p.last_name, a.appointment_id, a.appointment_date, a.reason, a.status,
       r.report_id, r.report_date, r.report_type, r.summary, d.name AS doctor_name
FROM Patients p
LEFT JOIN Appointments a ON p.patient_id = a.patient_id
LEFT JOIN MedicalReports r ON p.patient_id = r.patient_id
LEFT JOIN Doctors d ON (a.doctor_id = d.doctor_id OR r.doctor_id = d.doctor_id)
WHERE p.patient_id = 1
ORDER BY COALESCE(a.appointment_date, r.report_date) DESC;

-- 2. Doctor's appointments for a given day
SELECT a.appointment_id, p.first_name, p.last_name, a.appointment_date, a.reason, a.status
FROM Appointments a
JOIN Patients p ON a.patient_id = p.patient_id
WHERE a.doctor_id = 1 AND DATE(a.appointment_date) = '2025-11-03'
ORDER BY a.appointment_date;

-- 3. Check conflict before inserting an appointment (pseudocode via query)
-- Count overlapping appointments for doctor in the requested slot (assume 30 min slot)
SELECT COUNT(*) AS conflicts
FROM Appointments
WHERE doctor_id = 1
  AND appointment_date BETWEEN '2025-11-03 09:30:00' AND '2025-11-03 10:30:00'
  AND status = 'Scheduled';

-- 4. Get most recent report for a patient
SELECT * FROM MedicalReports
WHERE patient_id = 1
ORDER BY report_date DESC
LIMIT 1;

Select *From Departments;
Select *From Patients;
Select * from Appointments;
Select * from MedicalReports;